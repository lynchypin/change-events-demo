<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PagerDuty Demo - Incidents & Change Events</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f4f6fa;
      color: #222;
      min-height: 100vh;
    }
    header {
      background: #fff;
      color: #222;
      padding: 24px 0 16px 0;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      border-bottom: 1px solid #e5e7eb;
    }
    header h1 {
      margin: 0 0 8px 0;
      font-size: 2.2rem;
      letter-spacing: 1px;
      font-weight: 700;
    }
    header p {
      margin: 0;
      font-size: 1.1rem;
      color: #4b5563;
    }
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 16px 32px 16px;
    }
    .header {
      text-align: center;
      font-size: 1.5rem;
      font-weight: 600;
      margin-top: 32px;
      margin-bottom: 12px;
      letter-spacing: 0.5px;
    }
    .button-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(290px, 1fr));
      gap: 32px;
      margin-top: 24px;
      margin-bottom: 32px;
    }
    .event-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
      padding: 0 0 20px 0;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      position: relative;
      transition: box-shadow 0.2s;
      min-height: 340px;
    }
    .event-card:hover {
      box-shadow: 0 4px 20px rgba(0,0,0,0.13);
    }
    .product-img {
      width: 100%;
      height: 140px;
      background: #fff;
      object-fit: contain;
      display: block;
      border-radius: 16px 16px 0 0;
      margin-bottom: 10px;
      box-sizing: border-box;
      padding: 10px;
    }
    .event-title {
      font-size: 1.18rem;
      font-weight: 600;
      margin: 12px 0 12px 0;
      color: #222;
      text-align: center;
    }
    .priority-container {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 0 12px 0;
      gap: 8px;
    }
    .priority-label {
      font-size: 0.95rem;
      color: #374151;
      font-weight: 500;
    }
    .priority-select {
      padding: 6px 12px;
      font-size: 0.95rem;
      border: 2px solid #d1d5db;
      border-radius: 6px;
      background: #fff;
      color: #374151;
      cursor: pointer;
      font-weight: 600;
      transition: border-color 0.2s;
    }
    .priority-select:hover {
      border-color: #9ca3af;
    }
    .priority-select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    .trigger-btn {
      margin: 0 auto 10px auto;
      padding: 12px 0;
      width: 90%;
      font-size: 1.08rem;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      background: #1e293b;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
      box-shadow: 0 1px 4px rgba(16,185,129,0.08);
      display: block;
    }
    .trigger-btn:disabled {
      background: #cbd5e1;
      color: #4b5563;
      cursor: not-allowed;
    }
    .trigger-btn:hover:not(:disabled), .trigger-btn:focus:not(:disabled) {
      background: #2563eb;
    }
    .key-section {
      margin: 0 auto;
      margin-top: 8px;
      width: 90%;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .key-label {
      font-size: 0.98rem;
      color: #374151;
      margin-bottom: 2px;
    }
    .key-input-row {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .key-input {
      flex: 1;
      padding: 6px 8px;
      font-size: 1rem;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      background: #f9fafb;
      color: #222;
      transition: border 0.2s;
    }
    .key-input:focus {
      border: 1.5px solid #3182ce;
      outline: none;
    }
    .key-btn {
      padding: 6px 10px;
      font-size: 0.98rem;
      border: none;
      border-radius: 4px;
      background: #2563eb;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
    }
    .key-btn:hover, .key-btn:focus {
      background: #1e293b;
    }
    .key-clear-btn {
      background: #e53e3e;
      margin-left: 2px;
    }
    .key-clear-btn:hover, .key-clear-btn:focus {
      background: #b91c1c;
    }
    .key-status {
      font-size: 0.93rem;
      color: #059669;
      margin-top: 2px;
      margin-bottom: 0;
      min-height: 18px;
    }
    .modal-bg {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.22);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .modal {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 6px 32px rgba(0,0,0,0.18);
      padding: 32px 28px 24px 28px;
      max-width: 420px;
      width: 95vw;
      text-align: center;
      position: relative;
      animation: popIn 0.18s;
    }
    @keyframes popIn {
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .modal h2 {
      margin-top: 0;
      font-size: 1.3rem;
      color: #2d3748;
    }
    .modal p {
      font-size: 1.05rem;
      color: #374151;
      margin-bottom: 0;
    }
    .modal .close-btn {
      position: absolute;
      top: 12px;
      right: 14px;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #64748b;
      cursor: pointer;
      transition: color 0.2s;
    }
    .modal .close-btn:hover, .modal .close-btn:focus {
      color: #e53e3e;
    }
    .modal.success h2 { color: #059669; }
    .modal.error h2 { color: #e53e3e; }

    /* Change Event Card Styling */
    .change-event-card {
      border-left: 4px solid #0891b2;
    }
    .change-event-card .trigger-btn {
      background: #0891b2;
    }
    .change-event-card .trigger-btn:hover:not(:disabled) {
      background: #0e7490;
    }

    /* Workflow Card Styling */
    .workflow-card {
      border-left: 4px solid #7c3aed;
      grid-column: span 2;
    }
    .workflow-card .trigger-btn {
      background: #7c3aed;
    }
    .workflow-card .trigger-btn:hover:not(:disabled) {
      background: #6d28d9;
    }
    .workflow-steps {
      background: #f9fafb;
      border-radius: 8px;
      padding: 12px;
      margin: 12px 20px;
      font-size: 0.95rem;
      color: #4b5563;
      text-align: left;
    }
    .workflow-steps ol {
      margin: 8px 0;
      padding-left: 20px;
    }
    .workflow-steps li {
      margin: 4px 0;
    }

    /* Expandable Section Styling */
    .expanded-section {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease-out, opacity 0.3s ease-out;
      opacity: 0;
      grid-column: 1 / -1;
    }
    .expanded-section.open {
      max-height: 2000px;
      opacity: 1;
      transition: max-height 0.5s ease-in, opacity 0.4s ease-in;
    }
    .expanded-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(290px, 1fr));
      gap: 32px;
      padding: 20px 0;
    }

    @media (max-width: 900px) {
      .main-container { max-width: 98vw; }
      .button-grid { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
      .workflow-card { grid-column: span 1; }
    }
    @media (max-width: 600px) {
      .event-card { min-width: 90vw; max-width: 98vw; }
      .main-container { padding: 0 2vw 32px 2vw; }
    }

    .status-msg.error {
      color: #dc2626;
    }

    /* Simple Stats Dashboard */
    .stats-container {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin: 24px auto;
      max-width: 1200px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .stats-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 20px;
      color: #111827;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }
    .stat-box {
      background: #f9fafb;
      padding: 16px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #111827;
      margin-bottom: 4px;
    }
    .stat-label {
      font-size: 0.875rem;
      color: #6b7280;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <header>
    <h1>PagerDuty Demo - Incidents & Change Events</h1>
    <p>Trigger realistic incidents and send change events to demonstrate PagerDuty workflows.</p>
  </header>

  <!-- Stats Dashboard -->
  <div class="main-container">
    <div class="stats-container">
      <div class="stats-title">ðŸ“Š Demo Statistics</div>
      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-value" id="totalIncidents">0</div>
          <div class="stat-label">Total Incidents</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="totalChangeEvents">0</div>
          <div class="stat-label">Change Events</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="totalWorkflows">0</div>
          <div class="stat-label">Workflows Run</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="multipleFailuresQueue">0</div>
          <div class="stat-label">Multi-Incident Queue</div>
        </div>
      </div>
    </div>
  </div>

  <div class="main-container">
    <div class="header">ðŸ“‹ Incident Scenarios</div>
    <div class="button-grid" id="scenarioGrid" aria-label="Incident Scenarios"></div>

    <div class="header" style="margin-top: 48px;">ðŸ”„ Change Event Scenarios</div>
    <div class="button-grid" id="changeEventGrid" aria-label="Change Event Scenarios"></div>
  <div class="main-container">
    <div class="header">ðŸ“‹ Incident Scenarios</div>
    <div class="button-grid" id="scenarioGrid" aria-label="Incident Scenarios"></div>

    <div class="header" style="margin-top: 48px;">ðŸ”„ Change Event Scenarios</div>
    <div class="button-grid" id="changeEventGrid" aria-label="Change Event Scenarios"></div>

    <div class="header" style="margin-top: 48px;">ðŸŽ¯ Demo Workflows</div>
    <p style="text-align: center; color: #6b7280; margin-top: 8px; margin-bottom: 16px;">Automated sequences to demonstrate change correlation with incidents</p>
    <div class="button-grid" id="workflowGrid" aria-label="Demo Workflows"></div>
  </div>
  <div id="modalBg" class="modal-bg" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div id="modal" class="modal" tabindex="-1">
      <button class="close-btn" id="modalCloseBtn" aria-label="Close">&times;</button>
      <h2 id="modalTitle"></h2>
      <p id="modalMsg"></p>
    </div>
  </div>
  <script>
    // Statistics Tracking
    const stats = {
      incidents: 0,
      changeEvents: 0,
      workflows: 0,
      multipleFailuresQueue: 0
    };

    function loadStats() {
      const saved = localStorage.getItem('pagerduty_demo_stats');
      if (saved) {
        Object.assign(stats, JSON.parse(saved));
        updateStatsDisplay();
      }
    }

    function saveStats() {
      localStorage.setItem('pagerduty_demo_stats', JSON.stringify(stats));
    }

    function updateStatsDisplay() {
      document.getElementById('totalIncidents').textContent = stats.incidents;
      document.getElementById('totalChangeEvents').textContent = stats.changeEvents;
      document.getElementById('totalWorkflows').textContent = stats.workflows;
      document.getElementById('multipleFailuresQueue').textContent = stats.multipleFailuresQueue;
    }

    function trackIncident() {
      stats.incidents++;
      saveStats();
      updateStatsDisplay();
    }

    function trackChangeEvent() {
      stats.changeEvents++;
      saveStats();
      updateStatsDisplay();
    }

    function trackWorkflow() {
      stats.workflows++;
      saveStats();
      updateStatsDisplay();
    }

    function updateMultipleFailuresQueue(count) {
      stats.multipleFailuresQueue = count;
      saveStats();
      updateStatsDisplay();
    }

    // Load stats on page load
    loadStats();

    const scenarios = [
      {
        id: 'label_printer_offline',
        title: 'Label Printer Offline',
        desc: 'P1',
        location: 'Warehouse',
        locationClass: 'scenario-location',
        img: 'https://i.imgur.com/niG7rEV.jpeg',
        alt: 'Label Printer Offline',
        payload: {
          summary: 'Label printer is offline in the warehouse',
          severity: 'critical',
          source: 'Warehouse Printer',
          custom_details: { device: 'Label Printer', location: 'Warehouse', error: 'Offline' }
        }
      },
      {
        id: 'multiple_failures',
        title: 'Multiple Failures',
        desc: 'P1',
        location: 'Multiple Services at Once',
        locationClass: 'scenario-location',
        img: 'https://i.imgur.com/kvbUXW7.jpeg',
        alt: 'Multiple Failures',
        payload: {
          summary: 'Multiple critical failures detected across services',
          severity: 'critical',
          source: 'Service Monitor',
          custom_details: { affected: 'Multiple', error: 'Simultaneous failures' }
        }
      },
      {
        id: 'checkout_404',
        title: 'Checkout 404',
        desc: 'P1',
        location: 'Frontend',
        locationClass: 'scenario-location',
        img: 'https://i.imgur.com/dbxvlt5.jpeg',
        alt: 'Checkout 404',
        payload: {
          summary: 'Checkout page returns 404 error',
          severity: 'critical',
          source: 'Frontend',
          custom_details: { page: 'Checkout', error: '404 Not Found' }
        }
      },
      {
        id: 'fraudulent_card_activity',
        title: 'Fraudulent Card Activity Suspected',
        desc: 'P1',
        location: 'Finance',
        locationClass: 'scenario-location',
        img: 'https://i.imgur.com/j9Valif.jpeg',
        alt: 'Fraudulent Card Activity Suspected',
        payload: {
          summary: 'Fraudulent card activity detected',
          severity: 'critical',
          source: 'Finance',
          custom_details: { activity: 'Fraudulent', system: 'Card Processing' }
        }
      },
      {
        id: 'load_balancer_error',
        title: 'Load Balancer Error',
        desc: 'P1',
        location: 'Backend',
        locationClass: 'scenario-location',
        img: 'https://i.imgur.com/x23q15w.jpeg',
        alt: 'Load Balancer Error',
        payload: {
          summary: 'Load balancer error detected',
          severity: 'critical',
          source: 'Backend',
          custom_details: { component: 'Load Balancer', error: 'S18' }
        }
      },
      {
        id: 'change_event',
        title: 'Change Event',
        desc: 'P1',
        location: 'Git',
        locationClass: 'scenario-location',
        img: 'https://i.imgur.com/ScRUSB8.png',
        alt: 'Change Event',
        isExpandable: true,
        payload: {
          summary: 'Change event detected in Git',
          severity: 'critical',
          source: 'Git',
          custom_details: { event: 'Change', system: 'GitHub' }
        }
      },
      // Removed old generic "Change Event" card - replaced with specific change event scenarios below
    ];

    // Change Event Scenarios
    const changeEventScenarios = [
      {
        id: 'change_production_deploy',
        title: 'Production Deployment',
        desc: 'Deploy v2.4.0',
        location: 'CI/CD Pipeline',
        locationClass: 'scenario-location',
        img: 'https://i.imgur.com/9b239c98.jpeg',
        alt: 'Production Deployment',
        alt: 'Production Deployment',
        isChangeEvent: true,
        payload: {
          summary: 'Production deployment: v2.4.0 - Checkout service updates',
          source: 'github-actions',
          timestamp: () => new Date().toISOString(),
          custom_details: {
            version: 'v2.4.0',
            service: 'checkout-service',
            environment: 'production',
            deployed_by: 'deploy-bot',
            commit_sha: 'a3f5b2c',
            repository: 'company/checkout-service',
            branch: 'main',
            changes: 'Updated payment flow, fixed cart bug, performance improvements'
          }
        }
      },
      {
        id: 'change_frontend_deploy',
        title: 'Frontend Deployment',
        desc: 'UI Updates',
        location: 'Frontend',
        locationClass: 'scenario-location',
        img: 'https://i.imgur.com/c209c6cd.jpeg',
        alt: 'Frontend Deployment',
        isChangeEvent: true,
        payload: {
          summary: 'Frontend deployment: Updated checkout UI components',
          source: 'github-actions',
          timestamp: () => new Date().toISOString(),
          custom_details: {
            version: 'v3.2.1',
            service: 'frontend-web-app',
            environment: 'production',
            deployed_by: 'frontend-team',
            commit_sha: 'b7e9f1a',
            repository: 'company/frontend-app',
            changes: 'New checkout flow UI, improved mobile responsiveness'
          }
        }
      },
      {
        id: 'change_database_migration',
        title: 'Database Migration',
        desc: 'Schema Changes',
        location: 'Database',
        locationClass: 'scenario-location',
        img: 'https://i.imgur.com/cf874d23.jpeg',
        alt: 'Database Migration',
        isChangeEvent: true,
        payload: {
          summary: 'Database migration: Added indexes for performance optimization',
          source: 'database-migration-tool',
          timestamp: () => new Date().toISOString(),
          custom_details: {
            migration_id: '20240114_001',
            database: 'production-db',
            environment: 'production',
            executed_by: 'dba-team',
            duration_seconds: 45,
            changes: 'Added indexes on orders.customer_id and payments.transaction_id',
            tables_affected: ['orders', 'payments']
          }
        }
      },
      {
        id: 'change_config_update',
        title: 'Infrastructure Config Update',
        desc: 'Load Balancer Rules',
        location: 'Infrastructure',
        locationClass: 'scenario-location',
        img: 'https://i.imgur.com/aEIlroS.jpeg',
        alt: 'Config Update',
        isChangeEvent: true,
        payload: {
          summary: 'Load balancer configuration updated - New routing rules',
          source: 'terraform',
          timestamp: () => new Date().toISOString(),
          custom_details: {
            component: 'load-balancer-prod-01',
            environment: 'production',
            change_type: 'configuration',
            changed_by: 'devops-team',
            tool: 'Terraform v1.6.0',
            changes: 'Updated routing rules, increased timeout to 60s, added /health endpoint',
            affected_services: ['checkout-service', 'payment-api']
          }
        }
      }
    ];

    // Topic-based helpers for rich, correlated change events using only Change Event keys
    const TOPIC_CONFIG = {
      topic: "Checkout Latency Spike â€“ fastpath rollout",
      correlation_id: () => `topic-checkout-latency-${new Date().toISOString().slice(0,10)}`,
      burstScenarioId: 'change_production_deploy',
      incidentKeyScenarioId: 'change_production_deploy',
      count: 10,
      intervalMs: 3000
    };

    function generateTopicChangePayload(idx, total, baseScenario, topicCfg) {
      const ts = new Date(Date.now() - (total - idx) * 1000).toISOString();
      const regions = ['us-east-1','us-west-2','eu-central-1','ap-southeast-1'];
      const region = regions[idx % regions.length];
      const build = `checkout-${(new Date().getUTCFullYear())}.${4 + (idx%3)}.${idx}`;
      const commit = Math.random().toString(16).slice(2,9);
      const pr = 120 + idx;
      const ticket = `CHKO-${430 + idx}`;
      const corrId = topicCfg.correlation_id();

      const summary = `[Topic:${topicCfg.topic}] Change ${idx+1}/${total} â€“ fastpath=${idx%2===0?'enabled':'canary'}; region=${region}; build=${build}; commit=${commit}; PR#${pr}; ticket=${ticket}; corrId=${corrId}`;
      const custom = {
        ...baseScenario.payload.custom_details,
        topic: topicCfg.topic,
        correlation_id: corrId,
        region,
        build,
        commit_sha: commit,
        pr_number: pr,
        ticket,
        environment: 'production',
        service: 'checkout-service',
        feature_flag: 'fastpath',
        metrics: { p95_latency_ms: 220 + idx*7, error_rate_pct: +(0.3 * idx).toFixed(1) },
        links: [
          { href: `https://example.com/pr/${pr}`, text: `PR #${pr}` },
          { href: `https://example.com/tickets/${ticket}`, text: ticket }
        ]
      };

      return {
        routing_key: getIntegrationKey(baseScenario.id),
        payload: {
          summary,
          source: baseScenario.payload.source,
          timestamp: ts,
          custom_details: custom
        }
      };
    }

    function generateTopicIncidentPayload(baseScenario, topicCfg) {
      const corrId = topicCfg.correlation_id();
      const summary = `[Incident] ${topicCfg.topic} â€“ Elevated p95 on Checkout post-deploy; suspect fastpath flag interaction. corrId=${corrId}. Recent changes in same service/regions present.`;
      return {
        routing_key: getIntegrationKey(baseScenario.id), // using a Change Event key per request
        event_action: 'trigger',
        client: 'Change Events Demo',
        client_url: window.location.href,
        payload: {
          summary,
          severity: 'critical',
          source: 'synthetic-monitor',
          custom_details: {
            topic: topicCfg.topic,
            correlation_id: corrId,
            observed_metrics: { p95_latency_ms: 380, error_rate_pct: 4.7 },
            suspected_change: "fastpath enabled with reduced timeouts",
            service: 'checkout-service',
            environment: 'production'
          }
        }
      };
    }


    // Demo Workflow Scenarios
    const workflowScenarios = [
      {
        id: 'workflow_topic_change_burst_incident',
        title: 'ðŸŽ¯ Topic: Checkout Latency Spike â†’ 10 changes then 1 incident',
        desc: 'Uses only Change Event keys with context-rich summaries',
        location: 'Automated Workflow',
        locationClass: 'scenario-location',
        img: 'https://via.placeholder.com/400x140/7c3aed/ffffff?text=Topic+Burst',
        alt: 'Topic Burst Workflow',
        isWorkflow: true,
        topicConfig: TOPIC_CONFIG,
        steps: [
          // Send 10 related change events to the same service/key
          { action: 'send_change_event', scenario_id: TOPIC_CONFIG.burstScenarioId, delay_after: TOPIC_CONFIG.intervalMs },
          { action: 'send_change_event', scenario_id: TOPIC_CONFIG.burstScenarioId, delay_after: TOPIC_CONFIG.intervalMs },
          { action: 'send_change_event', scenario_id: TOPIC_CONFIG.burstScenarioId, delay_after: TOPIC_CONFIG.intervalMs },
          { action: 'send_change_event', scenario_id: TOPIC_CONFIG.burstScenarioId, delay_after: TOPIC_CONFIG.intervalMs },
          { action: 'send_change_event', scenario_id: TOPIC_CONFIG.burstScenarioId, delay_after: TOPIC_CONFIG.intervalMs },
          { action: 'send_change_event', scenario_id: TOPIC_CONFIG.burstScenarioId, delay_after: TOPIC_CONFIG.intervalMs },
          { action: 'send_change_event', scenario_id: TOPIC_CONFIG.burstScenarioId, delay_after: TOPIC_CONFIG.intervalMs },
          { action: 'send_change_event', scenario_id: TOPIC_CONFIG.burstScenarioId, delay_after: TOPIC_CONFIG.intervalMs },
          { action: 'send_change_event', scenario_id: TOPIC_CONFIG.burstScenarioId, delay_after: TOPIC_CONFIG.intervalMs },
          { action: 'send_change_event', scenario_id: TOPIC_CONFIG.burstScenarioId, delay_after: 0 },
          // Then trigger a single incident using one of the change event keys
          { action: 'trigger_incident', scenario_id: TOPIC_CONFIG.incidentKeyScenarioId, delay_after: 0 }
        ]
      }
    ];

    function getKeyStorageName(scenarioId) {
      return `pd_demo_integration_key_${scenarioId}`;
    }
    function saveIntegrationKey(scenarioId, key) {
      localStorage.setItem(getKeyStorageName(scenarioId), key);
    }
    function getIntegrationKey(scenarioId) {
      return localStorage.getItem(getKeyStorageName(scenarioId)) || '';
    }
    function clearIntegrationKey(scenarioId) {
      localStorage.removeItem(getKeyStorageName(scenarioId));
    }

    function showModal(type, title, msg) {
      const modalBg = document.getElementById('modalBg');
      const modal = document.getElementById('modal');
      const modalTitle = document.getElementById('modalTitle');
      const modalMsg = document.getElementById('modalMsg');
      modal.className = 'modal ' + (type === 'success' ? 'success' : 'error');
      modalTitle.textContent = title;
      modalMsg.textContent = msg;
      modalBg.style.display = 'flex';
      document.getElementById('modalCloseBtn').focus();
    }
    function closeModal() {
      document.getElementById('modalBg').style.display = 'none';
    }
    document.getElementById('modalCloseBtn').addEventListener('click', closeModal);
    document.getElementById('modalBg').addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') closeModal();
    });

    function renderScenarioGrid() {
      const grid = document.getElementById('scenarioGrid');
      grid.innerHTML = '';
      scenarios.forEach(scenario => {
        const card = document.createElement('div');
        card.className = 'event-card';
        card.setAttribute('data-scenario', scenario.id);

        const img = document.createElement('img');
        img.className = 'product-img';
        img.src = scenario.img;
        img.alt = scenario.alt;
        card.appendChild(img);

        const title = document.createElement('div');
        title.className = 'event-title';
        title.textContent = scenario.title;
        card.appendChild(title);

        // Priority dropdown (replacing the P1 desc)
        if (!scenario.isExpandable) {
          const priorityContainer = document.createElement('div');
          priorityContainer.className = 'priority-container';

          const priorityLabel = document.createElement('label');
          priorityLabel.className = 'priority-label';
          priorityLabel.textContent = 'Priority: ';
          priorityLabel.setAttribute('for', `priority-${scenario.id}`);

          const prioritySelect = document.createElement('select');
          prioritySelect.className = 'priority-select';
          prioritySelect.id = `priority-${scenario.id}`;
          prioritySelect.setAttribute('aria-label', `Priority level for ${scenario.title}`);

          for (let i = 1; i <= 5; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `P${i}`;
            if (i === 1) option.selected = true; // Default to P1
            prioritySelect.appendChild(option);
          }

          priorityContainer.appendChild(priorityLabel);
          priorityContainer.appendChild(prioritySelect);
          card.appendChild(priorityContainer);
        }

        const triggerBtn = document.createElement('button');
        triggerBtn.className = 'trigger-btn';
        triggerBtn.type = 'button';
        triggerBtn.textContent = scenario.isExpandable ? 'Choose Scenario' : 'Launch Incident';
        triggerBtn.setAttribute('aria-label', `Trigger ${scenario.title}`);
        triggerBtn.style.marginBottom = '10px';
        card.appendChild(triggerBtn);

        // Handle expandable card (Change Event)
        if (scenario.isExpandable) {
          // Don't show integration key section for expandable card
          triggerBtn.disabled = false;

          triggerBtn.addEventListener('click', function() {
            // Toggle the expanded section
            const expandedSection = document.getElementById('expandedChangeEvents');
            if (expandedSection) {
              expandedSection.classList.toggle('open');
              triggerBtn.textContent = expandedSection.classList.contains('open') ? 'Hide Scenarios' : 'Choose Scenario';
            }
          });

          grid.appendChild(card);
          return; // Skip the rest of the logic for expandable cards
        }

        // Only show integration key section for non-multiple_failures scenarios
        if (scenario.id !== 'multiple_failures') {
          const keySection = document.createElement('div');
          keySection.className = 'key-section';

          const keyLabel = document.createElement('label');
          keyLabel.className = 'key-label';
          keyLabel.setAttribute('for', `key-input-${scenario.id}`);
          keyLabel.textContent = 'Integration Key:';
          keySection.appendChild(keyLabel);

          const keyInputRow = document.createElement('div');
          keyInputRow.className = 'key-input-row';

          const keyInput = document.createElement('input');
          keyInput.className = 'key-input';
          keyInput.type = 'password';
          keyInput.id = `key-input-${scenario.id}`;
          keyInput.setAttribute('aria-label', `Integration key for ${scenario.title}`);
          keyInput.autocomplete = 'off';
          keyInput.value = getIntegrationKey(scenario.id);
          keyInput.placeholder = 'Paste integration key...';
          keyInputRow.appendChild(keyInput);

          const saveBtn = document.createElement('button');
          saveBtn.className = 'key-btn';
          saveBtn.type = 'button';
          saveBtn.textContent = 'Save';
          saveBtn.setAttribute('aria-label', `Save integration key for ${scenario.title}`);
          keyInputRow.appendChild(saveBtn);

          const clearBtn = document.createElement('button');
          clearBtn.className = 'key-btn key-clear-btn';
          clearBtn.type = 'button';
          clearBtn.textContent = 'Clear';
          clearBtn.setAttribute('aria-label', `Clear integration key for ${scenario.title}`);
          keyInputRow.appendChild(clearBtn);

          keySection.appendChild(keyInputRow);

          const keyStatus = document.createElement('div');
          keyStatus.className = 'key-status';
          keyStatus.id = `key-status-${scenario.id}`;
          keySection.appendChild(keyStatus);

          card.appendChild(keySection);

          function updateKeyStatus() {
            const key = getIntegrationKey(scenario.id);
            if (key) {
              keyStatus.textContent = 'Key saved';
              keyStatus.style.color = '#059669';
              keyInput.value = key;
            } else {
              keyStatus.textContent = 'No key saved';
              keyStatus.style.color = '#e53e3e';
              keyInput.value = '';
            }
          }
          updateKeyStatus();

          saveBtn.addEventListener('click', function() {
            const val = keyInput.value.trim();
            if (val.length < 32) {
              keyStatus.textContent = 'Key too short';
              keyStatus.style.color = '#e53e3e';
              return;
            }
            saveIntegrationKey(scenario.id, val);
            updateKeyStatus();
            triggerBtn.disabled = false;
          });

          clearBtn.addEventListener('click', function() {
            clearIntegrationKey(scenario.id);
            updateKeyStatus();
            triggerBtn.disabled = true;
          });

          keyInput.addEventListener('input', function() {
            triggerBtn.disabled = this.value.trim().length < 32;
          });

          triggerBtn.disabled = !getIntegrationKey(scenario.id);
        } else {
          // For multiple_failures, check if any other scenario has a key
          const hasAnyKey = scenarios.some(s => s.id !== 'multiple_failures' && getIntegrationKey(s.id));
          triggerBtn.disabled = !hasAnyKey;
        }

        triggerBtn.addEventListener('click', function() {
          // Special handling for multiple_failures scenario
          if (scenario.id === 'multiple_failures') {
            // Check if already running
            if (triggerBtn.dataset.running === 'true') {
              showModal('error', 'Already Running', 'Multiple failures scenario is already in progress. Please wait for it to complete.');
              return;
            }

            // Get all other scenarios with saved keys
            const otherScenariosWithKeys = scenarios.filter(s =>
              s.id !== 'multiple_failures' && getIntegrationKey(s.id)
            );

            if (otherScenariosWithKeys.length === 0) {
              showModal('error', 'No Keys Available', 'No other scenarios have integration keys saved. Please save keys for other scenarios first.');
              return;
            }

            // Mark as running
            triggerBtn.dataset.running = 'true';
            triggerBtn.disabled = true;

            const scenarioNames = otherScenariosWithKeys.map(s => s.title).join(', ');
            let waveCount = 0;
            const totalWaves = 3;
            const totalIncidents = otherScenariosWithKeys.length * totalWaves;
            updateMultipleFailuresQueue(totalIncidents);

            function sendWave() {
              waveCount++;

              // Send incidents for all scenarios with keys
              const promises = otherScenariosWithKeys.map(s => {
                // Get priority from dropdown
                const prioritySelect = document.getElementById(`priority-${s.id}`);
                const priority = prioritySelect ? prioritySelect.value : '1';
                const severityMap = { '1': 'critical', '2': 'error', '3': 'warning', '4': 'info', '5': 'info' };
                const severity = severityMap[priority] || 'critical';

                const payload = {
                  routing_key: getIntegrationKey(s.id),
                  event_action: 'trigger',
                  client: 'Change Events Demo',
                  client_url: window.location.href,
                  payload: {
                    summary: s.payload.summary,
                    severity: severity,
                    source: s.payload.source,
                    custom_details: s.payload.custom_details
                  }
                };
                return fetch('https://events.pagerduty.com/v2/enqueue', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
                });
              });

              Promise.all(promises).then(() => {
                if (waveCount < totalWaves) {
                  // Schedule next wave with countdown
                  let countdown = 10;
                  const countdownInterval = setInterval(() => {
                    countdown--;
                    triggerBtn.textContent = `Sending wave ${waveCount + 1} of ${totalWaves} to: ${scenarioNames} (${countdown}s)`;
                    if (countdown <= 0) {
                      clearInterval(countdownInterval);
                    }
                  }, 1000);

                  setTimeout(() => {
                    clearInterval(countdownInterval);
                    sendWave();
                  }, 10000);
                } else {
                  // All waves complete
                  const totalIncidents = otherScenariosWithKeys.length * totalWaves;
                  for (let i = 0; i < totalIncidents; i++) {
                    trackIncident();
                  }
                  updateMultipleFailuresQueue(0);
                  triggerBtn.dataset.running = 'false';
                  triggerBtn.disabled = false;
                  triggerBtn.textContent = 'Launch Incident';
                  showModal('success', 'Events Sent Successfully', `All ${totalWaves} waves of incidents have been triggered for: ${scenarioNames}`);
                }
              }).catch(err => {
                triggerBtn.dataset.running = 'false';
                triggerBtn.disabled = false;
                triggerBtn.textContent = 'Launch Incident';
                showModal('error', 'Error', 'Failed to send some incidents: ' + err);
              });

              // Update button text for current wave
              if (waveCount === 1) {
                triggerBtn.textContent = `Sending wave ${waveCount} of ${totalWaves} to: ${scenarioNames}`;
              }
            }

            // Start first wave
            sendWave();
            return;
          }

          // Original logic for all other scenarios
          const integrationKey = getIntegrationKey(scenario.id);
          if (!integrationKey) {
            showModal('error', 'No Integration Key', 'Please save an integration key for this scenario before triggering.');
            return;
          }

          // Get priority from dropdown
          const prioritySelect = document.getElementById(`priority-${scenario.id}`);
          const priority = prioritySelect ? prioritySelect.value : '1';
          const severityMap = { '1': 'critical', '2': 'error', '3': 'warning', '4': 'info', '5': 'info' };
          const severity = severityMap[priority] || 'critical';

          triggerBtn.disabled = true;
          triggerBtn.textContent = 'Sending...';
          const payload = {
            routing_key: integrationKey,
            event_action: 'trigger',
            client: 'Change Events Demo',
            client_url: window.location.href,
            payload: {
              summary: scenario.payload.summary,
              severity: severity,
              source: scenario.payload.source,
              custom_details: scenario.payload.custom_details
            }
          };
          fetch('https://events.pagerduty.com/v2/enqueue', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          })
          .then(async response => {
            const data = await response.json();
            if (response.ok && data.status === 'success') {
              trackIncident();
              showModal('success', 'Incident Triggered', 'PagerDuty incident triggered successfully.');
            } else {
              let msg = 'Failed to trigger incident.';
              if (data.errors && data.errors.length) msg += ' ' + data.errors.join(' ');
              showModal('error', 'Error', msg);
            }
          })
          .catch(err => {
            showModal('error', 'Network Error', 'Could not reach PagerDuty Events API. ' + err);
          })
          .finally(() => {
            triggerBtn.disabled = false;
            triggerBtn.textContent = 'Launch Incident';
          });
        });

        grid.appendChild(card);
      });

      // Add expanded section for change events after all cards
      const expandedSection = document.createElement('div');
      expandedSection.id = 'expandedChangeEvents';
      expandedSection.className = 'expanded-section';

      const expandedGrid = document.createElement('div');
      expandedGrid.className = 'expanded-grid';
      expandedGrid.id = 'expandedChangeEventsGrid';

      expandedSection.appendChild(expandedGrid);
      grid.appendChild(expandedSection);
    }

    function renderChangeEventGrid() {
      const grid = document.getElementById('expandedChangeEventsGrid');
      if (!grid) return; // Grid might not exist yet

      grid.innerHTML = '';
      changeEventScenarios.forEach(scenario => {
        const card = document.createElement('div');
        card.className = 'event-card change-event-card';
        card.setAttribute('data-scenario', scenario.id);

        const img = document.createElement('img');
        img.className = 'product-img';
        img.src = scenario.img;
        img.alt = scenario.alt;
        card.appendChild(img);

        const title = document.createElement('div');
        title.className = 'event-title';
        title.textContent = scenario.title;
        card.appendChild(title);

        const triggerBtn = document.createElement('button');
        triggerBtn.className = 'trigger-btn';
        triggerBtn.type = 'button';
        triggerBtn.textContent = 'Send Change Event';
        triggerBtn.setAttribute('aria-label', `Send ${scenario.title}`);
        triggerBtn.style.marginBottom = '10px';
        card.appendChild(triggerBtn);

        // Integration key section for change events
        const keySection = document.createElement('div');
        keySection.className = 'key-section';

        const keyLabel = document.createElement('label');
        keyLabel.className = 'key-label';
        keyLabel.setAttribute('for', `key-input-${scenario.id}`);
        keyLabel.textContent = 'Integration Key:';
        keySection.appendChild(keyLabel);

        const keyInputRow = document.createElement('div');
        keyInputRow.className = 'key-input-row';

        const keyInput = document.createElement('input');
        keyInput.className = 'key-input';
        keyInput.type = 'password';
        keyInput.id = `key-input-${scenario.id}`;
        keyInput.setAttribute('aria-label', `Integration key for ${scenario.title}`);
        keyInput.autocomplete = 'off';
        keyInput.value = getIntegrationKey(scenario.id);
        keyInput.placeholder = 'Paste integration key...';
        keyInputRow.appendChild(keyInput);

        const saveBtn = document.createElement('button');
        saveBtn.className = 'key-btn';
        saveBtn.type = 'button';
        saveBtn.textContent = 'Save';
        saveBtn.setAttribute('aria-label', `Save integration key for ${scenario.title}`);
        keyInputRow.appendChild(saveBtn);

        const clearBtn = document.createElement('button');
        clearBtn.className = 'key-btn key-clear-btn';
        clearBtn.type = 'button';
        clearBtn.textContent = 'Clear';
        clearBtn.setAttribute('aria-label', `Clear integration key for ${scenario.title}`);
        keyInputRow.appendChild(clearBtn);

        keySection.appendChild(keyInputRow);

        const keyStatus = document.createElement('div');
        keyStatus.className = 'key-status';
        keyStatus.id = `key-status-${scenario.id}`;
        keySection.appendChild(keyStatus);

        card.appendChild(keySection);

        function updateKeyStatus() {
          const key = getIntegrationKey(scenario.id);
          if (key) {
            keyStatus.textContent = 'Key saved';
            keyStatus.style.color = '#059669';
            keyInput.value = key;
          } else {
            keyStatus.textContent = 'No key saved';
            keyStatus.style.color = '#e53e3e';
            keyInput.value = '';
          }
        }
        updateKeyStatus();

        saveBtn.addEventListener('click', function() {
          const val = keyInput.value.trim();
          if (val.length < 32) {
            keyStatus.textContent = 'Key too short';
            keyStatus.style.color = '#e53e3e';
            return;
          }
          saveIntegrationKey(scenario.id, val);
          updateKeyStatus();
          triggerBtn.disabled = false;
        });

        clearBtn.addEventListener('click', function() {
          clearIntegrationKey(scenario.id);
          updateKeyStatus();
          triggerBtn.disabled = true;
        });

        keyInput.addEventListener('input', function() {
          triggerBtn.disabled = this.value.trim().length < 32;
        });

        triggerBtn.disabled = !getIntegrationKey(scenario.id);

        triggerBtn.addEventListener('click', function() {
          const integrationKey = getIntegrationKey(scenario.id);
          if (!integrationKey) {
            showModal('error', 'No Integration Key', 'Please save an integration key for this scenario before sending.');
            return;
          }
          triggerBtn.disabled = true;
          triggerBtn.textContent = 'Sending...';

          // Build change event payload
          const payload = {
            routing_key: integrationKey,
            payload: {
              summary: scenario.payload.summary,
              source: scenario.payload.source,
              timestamp: typeof scenario.payload.timestamp === 'function' ? scenario.payload.timestamp() : scenario.payload.timestamp,
              custom_details: scenario.payload.custom_details
            }
          };

          fetch('https://events.pagerduty.com/v2/change/enqueue', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          })
          .then(async response => {
            const data = await response.json();
            if (response.ok && data.status === 'success') {
              trackChangeEvent();
              showModal('success', 'Change Event Sent', 'PagerDuty change event sent successfully.');
            } else {
              let msg = 'Failed to send change event.';
              if (data.errors && data.errors.length) msg += ' ' + data.errors.join(' ');
              showModal('error', 'Error', msg);
            }
          })
          .catch(err => {
            showModal('error', 'Network Error', 'Could not reach PagerDuty Events API. ' + err);
          })
          .finally(() => {
            triggerBtn.disabled = false;
            triggerBtn.textContent = 'Send Change Event';
          });
        });

        grid.appendChild(card);
      });
    }

    function renderWorkflowGrid() {
      const grid = document.getElementById('workflowGrid');
      grid.innerHTML = '';
      workflowScenarios.forEach(workflow => {
        const card = document.createElement('div');
        card.className = 'event-card workflow-card';
        card.setAttribute('data-scenario', workflow.id);

        const img = document.createElement('img');
        img.className = 'product-img';
        img.src = workflow.img;
        img.alt = workflow.alt;
        card.appendChild(img);

        const title = document.createElement('div');
        title.className = 'event-title';
        title.textContent = workflow.title;
        card.appendChild(title);

        // Workflow steps display

        // Workflow steps display
        const stepsDiv = document.createElement('div');
        stepsDiv.className = 'workflow-steps';
        const stepsList = document.createElement('ol');
        workflow.steps.forEach(step => {
          const li = document.createElement('li');
          if (step.action === 'send_change_event') {
            const changeScenario = changeEventScenarios.find(s => s.id === step.scenario_id);
            li.textContent = `Send Change: ${changeScenario ? changeScenario.title : step.scenario_id}`;
          } else if (step.action === 'trigger_incident') {
            const incScenario = scenarios.find(s => s.id === step.scenario_id) || changeEventScenarios.find(s => s.id === step.scenario_id);
            li.textContent = `Trigger Incident (using CE key): ${incScenario ? incScenario.title : step.scenario_id}`;
          }
          if (step.delay_after > 0) {
            li.textContent += ` â†’ Wait ${step.delay_after / 1000}s`;
          }
          stepsList.appendChild(li);
        });
        stepsDiv.appendChild(stepsList);
        card.appendChild(stepsDiv);

        const triggerBtn = document.createElement('button');
        triggerBtn.className = 'trigger-btn';
        triggerBtn.type = 'button';
        triggerBtn.textContent = 'Run Workflow';
        triggerBtn.setAttribute('aria-label', `Run ${workflow.title}`);
        triggerBtn.style.marginTop = '10px';
        card.appendChild(triggerBtn);

        const statusDiv = document.createElement('div');
        statusDiv.className = 'key-status';
        statusDiv.style.marginTop = '10px';
        statusDiv.style.textAlign = 'center';
        card.appendChild(statusDiv);

        // Check if all required scenarios have keys
        function checkWorkflowReady() {
          const requiredScenarios = workflow.steps.map(step => {
            if (step.action === 'send_change_event' || step.action === 'trigger_incident') {
              return changeEventScenarios.find(s => s.id === step.scenario_id) || scenarios.find(s => s.id === step.scenario_id);
            }
            return null;
          }).filter(s => s !== null);

          // De-duplicate scenarios
          const uniqueRequired = [];
          const seen = new Set();
          for (const s of requiredScenarios) {
            if (!seen.has(s.id)) { seen.add(s.id); uniqueRequired.push(s); }
          }

          const missingKeys = uniqueRequired.filter(s => !getIntegrationKey(s.id));

          if (missingKeys.length > 0) {
            triggerBtn.disabled = true;
            statusDiv.textContent = `Missing keys: ${missingKeys.map(s => s.title).join(', ')}`;
            statusDiv.style.color = '#e53e3e';
            return false;
          } else {
            triggerBtn.disabled = false;
            statusDiv.textContent = 'Ready to run';
            statusDiv.style.color = '#059669';
            return true;
          }
        }
        checkWorkflowReady();

        triggerBtn.addEventListener('click', async function() {
          if (!checkWorkflowReady()) {
            showModal('error', 'Missing Keys', 'Please save integration keys for all required scenarios first.');
            return;
          }

          if (triggerBtn.dataset.running === 'true') {
            showModal('error', 'Already Running', 'This workflow is already in progress. Please wait for it to complete.');
            return;
          }

          triggerBtn.dataset.running = 'true';
          triggerBtn.disabled = true;

          let stepIndex = 0;

          async function executeStep() {
            if (stepIndex >= workflow.steps.length) {
              // Workflow complete
              trackWorkflow();
              triggerBtn.dataset.running = 'false';
              triggerBtn.disabled = false;
              triggerBtn.textContent = 'Run Workflow';
              statusDiv.textContent = 'Ready to run';
              statusDiv.style.color = '#059669';
              showModal('success', 'Workflow Complete', 'All steps have been executed successfully. Check PagerDuty to see the correlation!');
              return;
            }

            const step = workflow.steps[stepIndex];
            let scenario;
            let endpoint;
            let payload;

            if (step.action === 'send_change_event') {
              scenario = changeEventScenarios.find(s => s.id === step.scenario_id);
              endpoint = 'https://events.pagerduty.com/v2/change/enqueue';
              statusDiv.textContent = `Step ${stepIndex + 1}/${workflow.steps.length}: Sending ${scenario.title}...`;
              statusDiv.style.color = '#2563eb';

              // If workflow defines a topic, generate rich, correlated payloads
              if (workflow.topicConfig) {
                const idx = stepIndex; // step index maps to sequence
                payload = generateTopicChangePayload(idx, workflow.topicConfig.count, scenario, workflow.topicConfig);
              } else {
                payload = {
                  routing_key: getIntegrationKey(scenario.id),
                  payload: {
                    summary: scenario.payload.summary,
                    source: scenario.payload.source,
                    timestamp: typeof scenario.payload.timestamp === 'function' ? scenario.payload.timestamp() : scenario.payload.timestamp,
                    custom_details: scenario.payload.custom_details
                  }
                };
              }
            } else if (step.action === 'trigger_incident') {
              // Allow triggering incidents using a Change Event key per request
              scenario = scenarios.find(s => s.id === step.scenario_id) || changeEventScenarios.find(s => s.id === step.scenario_id);
              endpoint = 'https://events.pagerduty.com/v2/enqueue';
              statusDiv.textContent = `Step ${stepIndex + 1}/${workflow.steps.length}: Triggering incident using ${scenario.title} key...`;
              statusDiv.style.color = '#2563eb';

              if (workflow.topicConfig && changeEventScenarios.find(s => s.id === step.scenario_id)) {
                payload = generateTopicIncidentPayload(scenario, workflow.topicConfig);
              } else {
                payload = {
                  routing_key: getIntegrationKey(scenario.id),
                  event_action: 'trigger',
                  client: 'Change Events Demo',
                  client_url: window.location.href,
                  payload: {
                    summary: (scenario.payload && scenario.payload.summary) || 'Demo Incident',
                    severity: (scenario.payload && scenario.payload.severity) || 'critical',
                    source: (scenario.payload && scenario.payload.source) || 'demo',
                    custom_details: (scenario.payload && scenario.payload.custom_details) || {}
                  }
                };
              }
            }

            try {
              const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });

              const data = await response.json();
              if (!response.ok || data.status !== 'success') {
                throw new Error(data.errors ? data.errors.join(' ') : 'Failed to execute step');
              }

              // Wait for delay if specified
              if (step.delay_after > 0) {
                let countdown = step.delay_after / 1000;
                const countdownInterval = setInterval(() => {
                  countdown--;
                  statusDiv.textContent = `Step ${stepIndex + 1}/${workflow.steps.length} complete. Next step in ${countdown}s...`;
                  if (countdown <= 0) {
                    clearInterval(countdownInterval);
                  }
                }, 1000);

                await new Promise(resolve => setTimeout(resolve, step.delay_after));
                clearInterval(countdownInterval);
              }

              stepIndex++;
              executeStep();
            } catch (err) {
              triggerBtn.dataset.running = 'false';
              triggerBtn.disabled = false;
              triggerBtn.textContent = 'Run Workflow';
              statusDiv.textContent = 'Error occurred';
              statusDiv.style.color = '#e53e3e';
              showModal('error', 'Workflow Error', 'Failed to execute workflow: ' + err.message);
            }
          }

          executeStep();
        });

        grid.appendChild(card);
      });
    }

    renderScenarioGrid();
    renderChangeEventGrid();
    renderWorkflowGrid();
  </script>

  <!-- Custom Change Event Transformer (Jenkins) -->
  <div class="main-container">
    <div class="header" style="margin-top: 16px;">ðŸ§° Custom Change Event Transformer (Jenkins)</div>
    <div class="button-grid" aria-label="Custom Change Event Transformer">
      <div class="event-card change-event-card" id="cctr-card">
        <img class="product-img" src="https://via.placeholder.com/400x140/0891b2/ffffff?text=Jenkins+Transformer" alt="Custom Change Event Transformer">
        <div class="event-title">Test Your Transformer Endpoint</div>

        <div class="key-section">
          <label class="key-label" for="cctr-endpoint">Transformer Endpoint (POST URL)</label>
          <div class="key-input-row">
            <input class="key-input" id="cctr-endpoint" type="url" placeholder="https://your-domain.example.com/change-transformer" />
            <button class="key-btn" id="cctr-save" type="button">Save</button>
            <button class="key-btn key-clear-btn" id="cctr-clear" type="button">Clear</button>
          </div>
          <div class="key-status" id="cctr-status" aria-live="polite"></div>
        </div>

        <div class="key-section">
          <label class="key-label" for="cctr-payload">Preloaded Jenkins Payload</label>
          <textarea id="cctr-payload" rows="12" style="width: 90%; margin: 0 auto; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 12px; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; background: #f9fafb; color: #111827;"></textarea>
        </div>

        <button class="trigger-btn" id="cctr-send" type="button" style="margin-top: 12px;">Send to Transformer</button>
        <small style="display:block;text-align:center;color:#6b7280;">We will POST this payload to your transformer and log the response to the console.</small>
      </div>
    </div>
  </div>

  <script>
    // === Custom Change Event Transformer (Jenkins) Demo ===
    (function() {
      const KEY = 'cctr_endpoint_v1';
      const el = (id) => document.getElementById(id);
      const status = (msg, isError=false) => {
        const s = el('cctr-status');
        if (!s) return;
        s.textContent = msg || '';
        s.style.color = isError ? '#e53e3e' : '#059669';
      };
      const load = () => { try { return localStorage.getItem(KEY) || ''; } catch { return ''; } };
      const save = (v) => { try { localStorage.setItem(KEY, v || ''); return true; } catch { return false; } };

      const jenkinsSample = {
        name: 'jenkins',
        summary: 'Jenkins Build Completed',
        source: 'jenkins',
        timestamp: new Date().toISOString(),
        custom_details: {
          build: {
            full_url: 'https://jenkins.example.com/job/my-service/123/',
            number: 123,
            phase: 'COMPLETED',
            status: 'SUCCESS',
            scm: {
              branch: 'main',
              commit: 'a1b2c3d4e5f6g7h8i9j0',
              url: 'https://github.com/acme/my-service/commit/a1b2c3d'
            },
            project: 'my-service',
            duration_ms: 45892,
            user: 'jenkins'
          },
          deployment: {
            environment: 'staging',
            service: 'my-service',
            version: 'v1.4.7',
            changelog_url: 'https://github.com/acme/my-service/releases/tag/v1.4.7'
          }
        }
      };

      function init() {
        const endpointInput = el('cctr-endpoint');
        const saveBtn = el('cctr-save');
        const clearBtn = el('cctr-clear');
        const payloadTA = el('cctr-payload');
        const sendBtn = el('cctr-send');
        if (!endpointInput || !saveBtn || !clearBtn || !payloadTA || !sendBtn) return;

        endpointInput.value = load();
        payloadTA.value = JSON.stringify(jenkinsSample, null, 2);

        saveBtn.addEventListener('click', () => {
          const url = (endpointInput.value || '').trim();
          if (!url) return status('Please enter a valid URL', true);
          try { new URL(url); } catch { return status('Endpoint must be a valid URL', true); }
          save(url);
          status('Endpoint saved');
        });

        clearBtn.addEventListener('click', () => {
          endpointInput.value = '';
          save('');
          status('Endpoint cleared');
        });

        sendBtn.addEventListener('click', async () => {
          const url = (endpointInput.value || '').trim();
          if (!url) return status('Set the transformer endpoint first', true);
          let body;
          try {
            body = JSON.parse(payloadTA.value);
          } catch {
            return status('Payload is not valid JSON', true);
          }
          sendBtn.disabled = true;
          sendBtn.textContent = 'Sending...';
          status('Sending...');
          try {
            const res = await fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body)
            });
            const text = await res.text();
            let display = text;
            try { display = JSON.stringify(JSON.parse(text), null, 2); } catch {}
            if (res.ok) {
              status('Success! See console for response.');
              console.log('[Transformer OK]', display);
            } else {
              status(`Error ${res.status}. See console for details.`, true);
              console.error('[Transformer ERROR]', display);
            }
          } catch (e) {
            status(`Network/CORS error: ${e.message}`, true);
          } finally {
            sendBtn.disabled = false;
            sendBtn.textContent = 'Send to Transformer';
          }
        });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>

  <!-- External Endpoints to PagerDuty -->
  <div class="main-container" id="externalEndpoints">
    <div class="header" style="margin-top: 48px;">ðŸŒ External Endpoints to PagerDuty</div>
    <p style="text-align:center;color:#6b7280;margin:8px 0 20px;">
      Save the appropriate integration key per card, then use the buttons to fire events into PagerDuty at the right time in your demo.
    </p>

    <div class="button-grid" aria-label="External Endpoints">

      <!-- Cache Variables Demo: Query Gateway -->
      <div class="event-card" id="ext-cache-demo">
        <img class="product-img" src="https://via.placeholder.com/400x140/2563eb/ffffff?text=Cache+Variables+Demo" alt="Cache Variables Demo">
        <div class="event-title">Cache Variables Demo (Query Gateway)</div>

        <div class="key-section">
          <label class="key-label" for="ext-key-qgw">Integration Key (Query Gateway)</label>
          <div class="key-input-row">
            <input class="key-input" id="ext-key-qgw" type="password" placeholder="Paste Events API v2 key for Query Gateway">
            <button class="key-btn" id="ext-save-qgw" type="button">Save</button>
            <button class="key-btn key-clear-btn" id="ext-clear-qgw" type="button">Clear</button>
          </div>
          <div class="key-status" id="ext-status-qgw"></div>
        </div>

        <div class="key-section">
          <label class="key-label">Endpoint/Host (used to form the cache key)</label>
          <div class="key-input-row">
            <input class="key-input" id="ext-qgw-endpoint" type="text" value="/customer/search">
            <input class="key-input" id="ext-qgw-source" type="text" value="qgw-01">
          </div>
          <small style="color:#6b7280;">Recommended demo order: Step 1 â†’ Step 2 (wait 60s) â†’ Step 3</small>
        </div>

        <button class="trigger-btn" id="btn-cache-step1" type="button">Cache Step 1: Send 2 alerts</button>
        <button class="trigger-btn" id="btn-cache-step2" type="button">Cache Step 2: Start 60s wait</button>
        <button class="trigger-btn" id="btn-cache-step3" type="button">Cache Step 3: Send burst (5)</button>

        <div class="key-section">
          <label class="key-label" for="ext-burst-count">Burst size (5â€“10)</label>
          <div class="key-input-row">
            <input class="key-input" id="ext-burst-count" type="number" min="5" max="10" value="5">
            <button class="key-btn" id="btn-cache-step3-10" type="button">Send burst (10)</button>
          </div>
          <div class="key-status" id="ext-cache-status" aria-live="polite"></div>
        </div>
      </div>

      <!-- Ingest Pipeline: Dependency error -->
      <div class="event-card" id="ext-ingest">
        <img class="product-img" src="https://via.placeholder.com/400x140/059669/ffffff?text=Ingest+Dependency+Error" alt="Ingest Dependency Error">
        <div class="event-title">Ingest Pipeline: Dependency Error</div>

        <div class="key-section">
          <label class="key-label" for="ext-key-ingest">Integration Key (Ingest Pipeline)</label>
          <div class="key-input-row">
            <input class="key-input" id="ext-key-ingest" type="password" placeholder="Paste Events API v2 key for Ingest Pipeline">
            <button class="key-btn" id="ext-save-ingest" type="button">Save</button>
            <button class="key-btn key-clear-btn" id="ext-clear-ingest" type="button">Clear</button>
          </div>
          <div class="key-status" id="ext-status-ingest"></div>
        </div>

        <button class="trigger-btn" id="btn-ingest-send" type="button">Send dependency_error</button>
      </div>

      <!-- Leaf Nodes: Capacity pressure -->
      <div class="event-card" id="ext-leaf">
        <img class="product-img" src="https://via.placeholder.com/400x140/f59e0b/ffffff?text=Leaf+Nodes+Capacity" alt="Leaf Nodes Capacity Pressure">
        <div class="event-title">Leaf Nodes: Capacity Pressure</div>

        <div class="key-section">
          <label class="key-label" for="ext-key-leaf">Integration Key (Leaf Nodes)</label>
          <div class="key-input-row">
            <input class="key-input" id="ext-key-leaf" type="password" placeholder="Paste Events API v2 key for Leaf Nodes">
            <button class="key-btn" id="ext-save-leaf" type="button">Save</button>
            <button class="key-btn key-clear-btn" id="ext-clear-leaf" type="button">Clear</button>
          </div>
          <div class="key-status" id="ext-status-leaf"></div>
        </div>

        <button class="trigger-btn" id="btn-leaf-send" type="button">Send capacity_pressure</button>
      </div>

      <!-- Change Event: Production deploy -->
      <div class="event-card change-event-card" id="ext-change">
        <img class="product-img" src="https://via.placeholder.com/400x140/0891b2/ffffff?text=Change+Event" alt="Production Deployment Change">
        <div class="event-title">Change Event: Production Deployment</div>

        <div class="key-section">
          <label class="key-label" for="ext-key-change">Integration Key (Change Events)</label>
          <div class="key-input-row">
            <input class="key-input" id="ext-key-change" type="password" placeholder="Paste Change Events API key">
            <button class="key-btn" id="ext-save-change" type="button">Save</button>
            <button class="key-btn key-clear-change" id="ext-clear-change" type="button">Clear</button>
          </div>
          <div class="key-status" id="ext-status-change"></div>
        </div>

        <button class="trigger-btn" id="btn-change-send" type="button">Send production deploy change</button>
      </div>

    </div>
  </div>

  <script>
    // ---- External Endpoints logic ----
    (function() {
      // Local storage helpers (separate namespace to not collide with scenarios)
      const K = {
        qgw: 'ext_pd_key_qgw',
        ingest: 'ext_pd_key_ingest',
        leaf: 'ext_pd_key_leaf',
        change: 'ext_pd_key_change'
      };
      const $ = (id) => document.getElementById(id);
      const saveKey = (k, v) => { try { localStorage.setItem(k, v || ''); } catch {} };
      const getKey  = (k) => { try { return localStorage.getItem(k) || ''; } catch { return ''; } };
      const clrKey  = (k) => { try { localStorage.removeItem(k); } catch {} };

      // Status helper
      const status = (el, msg, ok=true) => {
        if (!el) return;
        el.textContent = msg || '';
        el.classList.toggle('error', !ok);
        el.style.color = ok ? '#059669' : '#e53e3e';
      };

      // Generic send to Events API
      async function sendPdEvent(routing_key, pdPayload) {
        const res = await fetch('https://events.pagerduty.com/v2/enqueue', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            routing_key,
            event_action: 'trigger',
            client: 'External Endpoints',
            client_url: window.location.href,
            payload: pdPayload
          })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.status !== 'success') {
          throw new Error((data.errors && data.errors.join(' ')) || `HTTP ${res.status}`);
        }
        return data;
      }

      // Change Events API
      async function sendPdChange(routing_key, changePayload) {
        const res = await fetch('https://events.pagerduty.com/v2/change/enqueue', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ routing_key, payload: changePayload })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.status !== 'success') {
          throw new Error((data.errors && data.errors.join(' ')) || `HTTP ${res.status}`);
        }
        return data;
      }

      // Initialize key UIs
      function initKey(idInput, idSave, idClear, idStatus, storeKey) {
        const input = $(idInput), saveBtn = $(idSave), clearBtn = $(idClear), st = $(idStatus);
        if (!input || !saveBtn || !clearBtn || !st) return;
        input.value = getKey(storeKey);
        status(st, input.value ? 'Key saved' : 'No key saved', !!input.value);

        saveBtn.addEventListener('click', () => {
          const v = (input.value || '').trim();
          if (v.length < 32) return status(st, 'Key too short', false);
          saveKey(storeKey, v);
          status(st, 'Key saved', true);
        });
        clearBtn.addEventListener('click', () => {
          clrKey(storeKey);
          input.value = '';
          status(st, 'Key cleared', false);
        });
      }

      // Wire key inputs
      initKey('ext-key-qgw',    'ext-save-qgw',    'ext-clear-qgw',    'ext-status-qgw',    K.qgw);
      initKey('ext-key-ingest', 'ext-save-ingest', 'ext-clear-ingest', 'ext-status-ingest', K.ingest);
      initKey('ext-key-leaf',   'ext-save-leaf',   'ext-clear-leaf',   'ext-status-leaf',   K.leaf);
      initKey('ext-key-change', 'ext-save-change', 'ext-clear-change', 'ext-status-change', K.change);

      // Cache Variables Demo (Query Gateway)
      const cacheStatus = $('ext-cache-status');
      const btnStep1 = $('btn-cache-step1');
      const btnStep2 = $('btn-cache-step2');
      const btnStep3 = $('btn-cache-step3');
      const btnStep3_10 = $('btn-cache-step3-10');

      function qgwPayload(endpoint, source) {
        return {
          summary: `Query Gateway 5xx spike on ${endpoint}`,
          severity: 'error',
          source,
          component: 'query-gateway',
          class: 'http_5xx',
          custom_details: {
            env: 'prod',
            cluster: 's2-prod-us-east-1',
            tenant: 'gold',
            endpoint,
            error_rate: +(30 + Math.random() * 10).toFixed(1),
            threshold: 15
          }
        };
      }

      // Step 1: Send 2 alerts
      btnStep1?.addEventListener('click', async () => {
        const key = getKey(K.qgw);
        if (!key) return showModal('error', 'Missing Key', 'Save the Query Gateway integration key first.');
        const endpoint = ($('ext-qgw-endpoint')?.value || '/customer/search').trim();
        const source = ($('ext-qgw-source')?.value || 'qgw-01').trim();
        btnStep1.disabled = true;
        status(cacheStatus, 'Sending 2 warm-up alerts...');
        try {
          await sendPdEvent(key, qgwPayload(endpoint, source));
          await sendPdEvent(key, qgwPayload(endpoint, source));
          status(cacheStatus, 'Warm-up complete: 2 alerts sent (expected: suppressed/no incident).');
          showModal('success', 'Sent', 'Sent 2 warm-up alerts.');
        } catch (e) {
          status(cacheStatus, 'Failed to send warm-up alerts: ' + e.message, false);
          showModal('error', 'Error', e.message);
        } finally {
          btnStep1.disabled = false;
        }
      });

      // Step 2: Start 60s wait (countdown)
      btnStep2?.addEventListener('click', () => {
        let remain = 60;
        btnStep2.disabled = true;
        status(cacheStatus, `Waiting ${remain}s before burst...`);
        const iv = setInterval(() => {
          remain--;
          status(cacheStatus, `Waiting ${remain}s before burst...`);
          if (remain <= 0) {
            clearInterval(iv);
            status(cacheStatus, 'Done waiting 60s. You can send the burst now.');
            btnStep2.disabled = false;
            showModal('success', 'Ready', '60 seconds elapsed. Proceed with the burst.');
          }
        }, 1000);
      });

      // Step 3: Send burst (N)
      async function sendBurst(n) {
        const key = getKey(K.qgw);
        if (!key) return showModal('error', 'Missing Key', 'Save the Query Gateway integration key first.');
        const endpoint = ($('ext-qgw-endpoint')?.value || '/customer/search').trim();
        const source = ($('ext-qgw-source')?.value || 'qgw-01').trim();
        const max = Math.max(5, Math.min(10, n || 5));
        btnStep3.disabled = true; btnStep3_10.disabled = true;
        status(cacheStatus, `Sending burst of ${max} alerts...`);
        try {
          const sends = [];
          for (let i = 0; i < max; i++) {
            // small jitter to simulate burst
            await new Promise(r => setTimeout(r, 150 + Math.random()*150));
            sends.push(sendPdEvent(key, qgwPayload(endpoint, source)));
          }
          await Promise.all(sends);
          status(cacheStatus, `Burst sent: ${max} alerts (expected: 1 incident, alerts grouped).`);
          showModal('success', 'Burst Sent', `Sent ${max} alerts.`);
        } catch (e) {
          status(cacheStatus, 'Failed to send burst: ' + e.message, false);
          showModal('error', 'Error', e.message);
        } finally {
          btnStep3.disabled = false; btnStep3_10.disabled = false;
        }
      }
      btnStep3?.addEventListener('click', () => {
        const n = parseInt(($('ext-burst-count')?.value || '5'), 10);
        sendBurst(n);
      });
      btnStep3_10?.addEventListener('click', () => sendBurst(10));

      // Ingest dependency_error
      $('btn-ingest-send')?.addEventListener('click', async () => {
        const key = getKey(K.ingest);
        if (!key) return showModal('error', 'Missing Key', 'Save the Ingest Pipeline integration key first.');
        const pdPayload = {
          summary: 'Ingest lag increasing: dependency timeout to Query Gateway',
          severity: 'error',
          source: 'ingest-worker-05',
          component: 'ingest-pipeline',
          class: 'dependency_error',
          custom_details: {
            env: 'prod',
            cluster: 's2-prod-us-east-1',
            tenant: 'gold',
            dependency: 'query-gateway',
            lag_seconds: 120 + Math.floor(Math.random()*60)
          }
        };
        const btn = $('btn-ingest-send');
        btn.disabled = true;
        try {
          await sendPdEvent(key, pdPayload);
          showModal('success', 'Event Sent', 'Ingest dependency_error sent.');
        } catch (e) {
          showModal('error', 'Error', e.message);
        } finally {
          btn.disabled = false;
        }
      });

      // Leaf Nodes capacity_pressure
      $('btn-leaf-send')?.addEventListener('click', async () => {
        const key = getKey(K.leaf);
        if (!key) return showModal('error', 'Missing Key', 'Save the Leaf Nodes integration key first.');
        const pdPayload = {
          summary: 'Leaf nodes disk utilization > 90%',
          severity: 'error',
          source: 'leaf-03',
          component: 'leaf-nodes',
          class: 'capacity_pressure',
          custom_details: {
            env: 'prod',
            cluster: 's2-prod-us-east-1',
            tenant: 'gold'
          }
        };
        const btn = $('btn-leaf-send');
        btn.disabled = true;
        try {
          await sendPdEvent(key, pdPayload);
          showModal('success', 'Event Sent', 'Leaf Nodes capacity_pressure sent.');
        } catch (e) {
          showModal('error', 'Error', e.message);
        } finally {
          btn.disabled = false;
        }
      });

      // Change Event: Production deploy
      $('btn-change-send')?.addEventListener('click', async () => {
        const key = getKey(K.change);
        if (!key) return showModal('error', 'Missing Key', 'Save the Change Events integration key first.');
        const changePayload = {
          summary: 'Production deployment: SingleStore Query Gateway v2.4.0',
          source: 'github-actions',
          timestamp: new Date().toISOString(),
          custom_details: {
            version: 'v2.4.0',
            service: 'query-gateway',
            environment: 'production',
            deployed_by: 'deploy-bot',
            commit_sha: Math.random().toString(16).slice(2,9),
            repository: 'singlestore/query-gateway',
            changes: 'Fastpath enabled; timeout adjustments; minor perf tuning'
          }
        };
        const btn = $('btn-change-send');
        btn.disabled = true;
        try {
          await sendPdChange(key, changePayload);
          showModal('success', 'Change Sent', 'Production deploy change event sent.');
        } catch (e) {
          showModal('error', 'Error', e.message);
        } finally {
          btn.disabled = false;
        }
      });
    })();
  </script>
</body>
</html>
